<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<style>
.selected {background: red;}
</style>
<ul data-role="playlist-order"></ul>
<ul data-role="playlists"></ul>
<ul data-role="videos"></ul>

<span data-role="next-page">Next page</span>
<span data-role="prev-page">Prev page</span>

<script id="video_list_template" type="text/template">
	<li>
		<h3>{title}</h3>
		<h4>{description}</h4>
		<img src="{thumbnail.hqDefault}" alt="{title}">
	</li>
</script>
<script id="playlist_template" type="text/template">
	<li>
		<a class="{class}" href="#{id}">{title}</a>
	</li>
</script>
<script id="order_by_template" type="text/template">
	<li>
		<a class="{class}" href="#{order}">{title}</a>
	</li>
</script>

<script>
// This is the templating system
function nano(template, data) {
	return template.replace(/\{([\w\.]*)\}/g, function(str, key) {
	var keys = key.split("."), v = data[keys.shift()];
	for (var i = 0, l = keys.length; i < l; i++) v = v[keys[i]];
	return (typeof v !== "undefined" && v !== null) ? v : "";
	});
}
// /end templating system

var options = {
	index_count: 1,
	per_page: 2,
	page_number: 1,
	max_pages: 2,

	video_container: 'ul[data-role="videos"]',
	playlist_container: 'ul[data-role="playlists"]',
	order_by_container: 'ul[data-role="playlist-order"]',
	next_link: 'span[data-role="next-page"]',
	prev_link: 'span[data-role="prev-page"]',

	playlist_selected_element: 'a',
	order_by_selected_element: 'a',

	video_list_template: $('#video_list_template').text(),
	playlist_template: $('#playlist_template').text(),
	order_by_template: $('#order_by_template').text(),

	uploads_title: 'All Uploads',
	order_by: 'published',
	selected_class: 'selected',
	user: 'mikestreety',

	current_playlist: false,
	format: 'jsonc',
	api_version: 2,
	api_base_url: 'https://gdata.youtube.com/feeds/api'
}

var urls = {
	user_uploads: options.api_base_url + '/users/' + options.user + '/uploads',
	user_playlists: options.api_base_url + '/users/' + options.user + '/playlists',
	playlist_videos: options.api_base_url + '/playlists/'
}

var next_link = $(options.next_link);
var prev_link = $(options.prev_link);

function draw_thumbs(data) {
	var container = $(options.video_container);
	container.fadeOut(500, function(){
		container.empty();
		$.each(data.data.items, function(index, val) {
			var video = (val.video)? val.video : val;
			container.append(nano(options.video_list_template, video)).fadeIn();
		});
	})
}

function draw_playlists(data){
	data.data.items.unshift({
		link: false,
		title: options.uploads_title
	});
	$.each(data.data.items, function(index, val) {
		val.class = (val.link == options.current_playlist) ? options.selected_class : '';
		$(options.playlist_container).append(nano(options.playlist_template, val));
	});
}

function draw_order_by() {
	var orders = [
		{title: 'Date', order: 'published'},
		{title: 'View Count', order: 'viewCount'},
		{title: 'Title', order: 'title'},
	];

	// {title: 'Duration', order: 'duration'},
	var container = $(options.order_by_container)
	$.each(orders, function(index, val) {
		val.class = (val.order == options.order_by) ? options.selected_class : '';
		container.append(nano(options.order_by_template, val));
	});
}

function pagination_visual(data){


	options.max_pages = Math.ceil(data.data.totalItems / options.per_page);
	if(options.page_number === options.max_pages)
		next_link.hide();
	else
		next_link.show();

	if(options.page_number === 1)
		prev_link.hide();
	else
		prev_link.show();
}

function pagination(operator) {
	options.index_count = eval(options.index_count + operator + options.per_page);
	if(operator == '+')
		options.page_number++;
	else
		options.page_number--;

	get_videos(options.playlist_link);
}

function get_videos(url){
	url = (url) ?  urls.playlist_videos + url : urls.user_uploads;
	$.ajax({
		url: url,
		data: {
			'v': options.api_version,
			'alt': options.format,
			'order_by': options.order_by,
			'start-index': options.index_count,
			'max-results': options.per_page
		},
		success: function(data){
			draw_thumbs(data);
			pagination_visual(data);
		}
	});
}

function get_playlists(){
	$.ajax({
		url: urls.user_playlists,
		data: {
			'v': options.api_version,
			'alt': options.format,
			'order_by': options.order_by,
		},
		success: function(data){
			draw_playlists(data);
		}
	});
}

$('body').on('click', options.playlist_container + ' a', function(e){

	var self = $(this);
	var link = self.attr('href').replace(/#/,'');

	options.index_count = 1;
	options.page_number = 1;
	options.current_playlist = window.location.hash = link;

	self.parents(options.playlist_container).find(options.playlist_selected_element).removeClass(options.selected_class);
	self.addClass(options.selected_class);

	get_videos(link);

	e.preventDefault();
});
$('body').on('click', options.order_by_container + ' a', function(e){
	var self = $(this);
	var order = self.attr('href').replace(/#/,'');

	options.index_count = 1;
	options.page_number = 1;
	options.order_by = order;

	get_videos(options.current_playlist);

	self.parents(options.order_by_container).find(options.order_by_selected_element).removeClass(options.selected_class);
	self.addClass(options.selected_class);

	e.preventDefault();
});

next_link.on('click', function(){
	pagination('+');
});
prev_link.on('click', function(){
	pagination('-');
});

get_videos();
get_playlists();
draw_order_by();
</script>
