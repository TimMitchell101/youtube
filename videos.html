<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<ul class="js-order"></ul>
<ul class="js-playlists"></ul>
<ul class="js-videos"></ul>

<span class="js-next">Next page</span>
<span class="js-prev">Prev page</span>

<script id="video_list_template" type="text/template">
	<li>
		<h3>{title}</h3>
		<h4>{description}</h4>
		<img src="{thumbnail.hqDefault}" alt="{title}">
	</li>
</script>
<script id="playlist_template" type="text/template">
	<li>
		<a href="#{id}">{title}</a>
	</li>
</script>
<script id="order_by_template" type="text/template">
	<li>
		<a href="#{order}">{title}</a>
	</li>
</script>

<script>
// This is the templating system
function nano(template, data) {
	return template.replace(/\{([\w\.]*)\}/g, function(str, key) {
	var keys = key.split("."), v = data[keys.shift()];
	for (var i = 0, l = keys.length; i < l; i++) v = v[keys[i]];
	return (typeof v !== "undefined" && v !== null) ? v : "";
	});
}
// /end templating system

var options = {
	index_count: 1,
	per_page: 2,
	page_number: 1,
	max_pages: 2,

	video_container: '.js-videos',
	playlist_container: '.js-playlists',
	order_by_container: '.js-order',
	next_link: '.js-next',
	prev_link: '.js-prev',

	video_list_template: $('#video_list_template').text(),
	playlist_template: $('#playlist_template').text(),
	order_by_template: $('#order_by_template').text(),

	uploads_title: 'All Uploads',
	orderby: 'published',
	user: 'mikestreety',

	current_playlist: false,
	format: 'jsonc',
	api_version: 2,
	api_base_url: 'https://gdata.youtube.com/feeds/api'
}

var urls = {
	user_uploads: options.api_base_url + '/users/' + options.user + '/uploads',
	user_playlists: options.api_base_url + '/users/' + options.user + '/playlists',
	playlist_videos: options.api_base_url + '/playlists/'
}

var next_link = $(options.next_link);
var prev_link = $(options.prev_link);

function draw_thumbs(data) {
	var container = $(options.video_container);
	container.fadeOut(500, function(){
		container.empty();
		$.each(data.data.items, function(index, val) {
			var video = (val.video)? val.video : val;
			container.append(nano(options.video_list_template, video)).fadeIn();
		});
	})
}

function draw_playlists(data){
	data.data.items.unshift({
		link: '',
		title: options.uploads_title
	});
	$.each(data.data.items, function(index, val) {
		$(options.playlist_container).append(nano(options.playlist_template, val));
	});
}

function draw_order_by() {
	var orders = [
		{title: 'Date', order: 'published'},
		{title: 'View Count', order: 'viewCount'},
		{title: 'Title', order: 'title'},
	];

	// {title: 'Duration', order: 'duration'},
	var container = $(options.order_by_container)
	$.each(orders, function(index, val) {
		container.append(nano(options.order_by_template, val));
	});
}

function pagination_visual(data){


	options.max_pages = Math.ceil(data.data.totalItems / options.per_page);
	if(options.page_number === options.max_pages)
		next_link.hide();
	else
		next_link.show();

	if(options.page_number === 1)
		prev_link.hide();
	else
		prev_link.show();
}

function pagination(operator) {
	options.index_count = eval(options.index_count + operator + options.per_page);
	if(operator == '+')
		options.page_number++;
	else
		options.page_number--;

	get_videos(options.playlist_link);
}

function get_videos(url){
	url = (url) ?  urls.playlist_videos + url : urls.user_uploads
	$.ajax({
		url: url,
		data: {
			'v': options.api_version,
			'alt': options.format,
			'orderby': options.orderby,
			'start-index': options.index_count,
			'max-results': options.per_page
		},
		success: function(data){
			draw_thumbs(data);
			pagination_visual(data);
		}
	});
}

function get_playlists(){
	$.ajax({
		url: urls.user_playlists,
		data: {
			'v': options.api_version,
			'alt': options.format,
			'orderby': options.orderby,
		},
		success: function(data){
			draw_playlists(data);
		}
	});
}

$('body').on('click', options.playlist_container + ' a', function(e){
	var playlist_link = $(this).attr('href');
	var link = playlist_link.replace(/#/,'');
	options.index_count = 1;
	options.page_number = 1;

	window.location.hash = options.current_playlist = link;

	get_videos(link);

	e.preventDefault();
});
$('body').on('click', options.order_by_container + ' a', function(e){
	var playlist_order = $(this).attr('href');
	var order = playlist_order.replace(/#/,'');

	options.index_count = 1;
	options.page_number = 1;
	options.orderby = order;

	get_videos(options.current_playlist);

	e.preventDefault();
});

next_link.on('click', function(){
	pagination('+');
});
prev_link.on('click', function(){
	pagination('-');
});

get_videos();
get_playlists();
draw_order_by();
</script>
